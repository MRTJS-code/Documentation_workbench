
-- ===================================================
-- Author:		Charlene Sy
-- Create date: 2023-12-01
-- Description:	stored proc for building dim_GHS_USERS
-- ===================================================
CREATE PROCEDURE [dw].[proc_fact_GHS_Activities]
-- Add the parameters for the stored procedure here
	@p_job int,  
	@p_run int,	
	@p_pack varchar(70),
	@P_USER varchar(70)	
AS

SELECT DISTINCT
       A.[ID],
       U.SK_DIM_USERS AS FK_SK_DIM_USERS,
       O.SK_DIM_ORGANISATIONS AS FK_SK_DIM_ORGANISATIONS,
       D.SK_DIM_DATE AS FK_SK_DIM_DATE,
       A.[NAME],
       A.[REFERENCE],
       LEFT(A.[NOTES], 256) AS NOTES,
       A.[STATUS],
       A.[TYPE],
       A.[TYPE_CATEGORY],
       A.[START_TIME],
       A.[FINISH_TIME],
       A.[SCHEDULED_START_TIME],
       A.[SCHEDULED_FINISH_TIME],
       A.[IS_PLANNED],
       A.[IS_FAVOURITE],
       A.[IS_ROUND_TRIP],
       A.[IS_ALERTED],
       A.[IS_ONGOING],
       A.[IS_ARCHIVED],
       A.[START_LATITUDE],
       A.[START_LONGITUDE],
       A.[START_ADDRESS],
       A.[DESTINATION_LATITUDE],
       A.[DESTINATION_LONGITUDE],
       A.[DESTINATION_ADDRESS],
       A.[TIMER_TYPE],
       A.[TIMER_TOD_TIME],
       A.[REMINDER_THRESHOLD],
       A.[TIMER_INTERVAL_MINUTES],
       A.[DASHBOARD_URL],
       A.[TRACKER_URL],
       A.[CREATED_AT],
       A.[UPDATED_AT],
       A.[GOT_IN_TROUBLE_AT],
       A.[IS_FOLLOWED_UP],
       A.[IS_FOLLOWED_UP_COMPLETED],
       A.[APPROVAL_STATUS],
       A.[V_BTTN_SERIAL_NUMBER],
       S.[DURATION_SECONDS],
       S.[TOTAL_DISTANCE_METRES],
       S.[AUTO_CHECKIN_COUNT],
       S.[MANUAL_CHECKIN_COUNT],
       S.[HASHTAG_CHECKIN_COUNT],
       S.[GPS_CHECKIN_COUNT],
       S.[VEHICLE_CHECKIN_COUNT],
       S.[ESTIMATED_DISTANCE_METRES],
       S.[ACCURACY_AVG_METRES],
       S.[ALTITUDE_AVG_METRES],
       S.[ALTITUDE_MED_METRES],
       S.[ALTITUDE_MIN_METRES],
       S.[ALTITUDE_MAX_METRES],
       S.[SPEED_AVG_KMH],
       S.[SPEED_MED_KMH],
       S.[SPEED_MIN_KMH],
       S.[SPEED_MAX_KMH]
INTO #TEMPEMP
FROM [ODS_NZ_SEC].[STAGING].[GHS_ACTIVITIES] A
LEFT JOIN [STAGING].[GHS_ACTIVITIES_STATISTIC] S ON A.ID = S.activity_id
LEFT JOIN [DW].[DIM_GHS_USERS] U ON A.USER_ID = U.PK_USER_ID
LEFT JOIN [DW].[DIM_GHS_ORGANISATIONS] O ON O.PK_ID = A.[ORGANISATION_ID]
LEFT JOIN [DW].[DIM_DATE] D ON FORMAT(CONVERT(DATE, A.START_TIME), 'yyyyMMdd') = D.SK_DIM_DATE;

-- Perform merge operation with duplication validation
MERGE INTO [DW].[FACT_GHS_ACTIVITIES] AS A
USING (
    SELECT
        B.ID,
        B.FK_SK_DIM_USERS,
        B.FK_SK_DIM_ORGANISATIONS,
        B.FK_SK_DIM_DATE,
        B.NAME,
        B.REFERENCE,
        B.NOTES,
        B.STATUS,
        B.TYPE,
        B.TYPE_CATEGORY,
        B.START_TIME,
        B.FINISH_TIME,
        B.SCHEDULED_START_TIME,
        B.SCHEDULED_FINISH_TIME,
        B.IS_PLANNED,
        B.IS_FAVOURITE,
        B.IS_ROUND_TRIP,
        B.IS_ALERTED,
        B.IS_ONGOING,
        B.IS_ARCHIVED,
        B.START_LATITUDE,
        B.START_LONGITUDE,
        B.START_ADDRESS,
        B.DESTINATION_LATITUDE,
        B.DESTINATION_LONGITUDE,
        B.DESTINATION_ADDRESS,
        B.TIMER_TYPE,
        B.TIMER_TOD_TIME,
        B.REMINDER_THRESHOLD,
        B.TIMER_INTERVAL_MINUTES,
        B.DASHBOARD_URL,
        B.TRACKER_URL,
        B.CREATED_AT,
        B.UPDATED_AT,
        B.GOT_IN_TROUBLE_AT,
        B.IS_FOLLOWED_UP,
        B.IS_FOLLOWED_UP_COMPLETED,
        B.APPROVAL_STATUS,
        B.V_BTTN_SERIAL_NUMBER,
        B.DURATION_SECONDS,
        B.TOTAL_DISTANCE_METRES,
        B.AUTO_CHECKIN_COUNT,
        B.MANUAL_CHECKIN_COUNT,
        B.HASHTAG_CHECKIN_COUNT,
        B.GPS_CHECKIN_COUNT,
        B.VEHICLE_CHECKIN_COUNT,
        B.ESTIMATED_DISTANCE_METRES,
        B.ACCURACY_AVG_METRES,
        B.ALTITUDE_AVG_METRES,
        B.ALTITUDE_MED_METRES,
        B.ALTITUDE_MIN_METRES,
        B.ALTITUDE_MAX_METRES,
        B.SPEED_AVG_KMH,
        B.SPEED_MED_KMH,
        B.SPEED_MIN_KMH,
        B.SPEED_MAX_KMH
    FROM #TEMPEMP B
    WHERE NOT EXISTS (
        SELECT 1
        FROM [DW].[FACT_GHS_ACTIVITIES] FA
        WHERE FA.PK_ACTIVITY_ID = B.ID
    )
) AS B ON A.PK_ACTIVITY_ID = B.ID
WHEN MATCHED THEN
    UPDATE SET
        A.FK_SK_DIM_USERS = B.FK_SK_DIM_USERS,
        A.FK_SK_DIM_ORGANISATIONS = B.FK_SK_DIM_ORGANISATIONS,
        A.FK_SK_DIM_DATE = B.FK_SK_DIM_DATE,
        A.P_NAME = B.NAME,
        A.P_REFERENCE = B.REFERENCE,
        A.P_NOTES = B.NOTES,
        A.P_STATUS = B.STATUS,
        A.P_TYPE = B.TYPE,
        A.P_TYPE_CATEGORY = B.TYPE_CATEGORY,
        A.P_START_TIME = B.START_TIME,
        A.P_FINISH_TIME = B.FINISH_TIME,
        A.P_SCHEDULED_START_TIME = B.SCHEDULED_START_TIME,
        A.P_SCHEDULED_FINISH_TIME = B.SCHEDULED_FINISH_TIME,
        A.P_IS_PLANNED = B.IS_PLANNED,
        A.P_IS_FAVOURITE = B.IS_FAVOURITE,
        A.P_IS_ROUND_TRIP = B.IS_ROUND_TRIP,
        A.P_IS_ALERTED = B.IS_ALERTED,
        A.P_IS_ONGOING = B.IS_ONGOING,
        A.P_IS_ARCHIVED = B.IS_ARCHIVED,
        A.P_START_LATITUDE = B.START_LATITUDE,
        A.P_START_LONGITUDE = B.START_LONGITUDE,
        A.P_START_ADDRESS = B.START_ADDRESS,
        A.P_DESTINATION_LATITUDE = B.DESTINATION_LATITUDE,
        A.P_DESTINATION_LONGITUDE = B.DESTINATION_LONGITUDE,
        A.P_DESTINATION_ADDRESS = B.DESTINATION_ADDRESS,
        A.P_TIMER_TYPE = B.TIMER_TYPE,
        A.P_TIMER_TOD_TIME = B.TIMER_TOD_TIME,
        A.P_REMINDER_THRESHOLD = B.REMINDER_THRESHOLD,
        A.P_TIMER_INTERVAL_MINUTES = B.TIMER_INTERVAL_MINUTES,
        A.P_DASHBOARD_URL = B.DASHBOARD_URL,
        A.P_TRACKER_URL = B.TRACKER_URL,
        A.P_CREATED_AT = B.CREATED_AT,
        A.P_UPDATED_AT = B.UPDATED_AT,
        A.P_GOT_IN_TROUBLE_AT = B.GOT_IN_TROUBLE_AT,
        A.P_IS_FOLLOWED_UP = B.IS_FOLLOWED_UP,
        A.P_IS_FOLLOWED_UP_COMPLETED = B.IS_FOLLOWED_UP_COMPLETED,
        A.P_APPROVAL_STATUS = B.APPROVAL_STATUS,
        A.P_V_BTTN_SERIAL_NUMBER = B.V_BTTN_SERIAL_NUMBER,
        A.P_DURATION_SECONDS = B.DURATION_SECONDS,
        A.P_TOTAL_DISTANCE_METRES = B.TOTAL_DISTANCE_METRES,
        A.P_AUTO_CHECKIN_COUNT = B.AUTO_CHECKIN_COUNT,
        A.P_MANUAL_CHECKIN_COUNT = B.MANUAL_CHECKIN_COUNT,
        A.P_HASHTAG_CHECKIN_COUNT = B.HASHTAG_CHECKIN_COUNT,
        A.P_GPS_CHECKIN_COUNT = B.GPS_CHECKIN_COUNT,
        A.P_VEHICLE_CHECKIN_COUNT = B.VEHICLE_CHECKIN_COUNT,
        A.P_ESTIMATED_DISTANCE_METRES = B.ESTIMATED_DISTANCE_METRES,
        A.P_ACCURACY_AVG_METRES = B.ACCURACY_AVG_METRES,
        A.P_ALTITUDE_AVG_METRES = B.ALTITUDE_AVG_METRES,
        A.P_ALTITUDE_MED_METRES = B.ALTITUDE_MED_METRES,
        A.P_ALTITUDE_MIN_METRES = B.ALTITUDE_MIN_METRES,
        A.P_ALTITUDE_MAX_METRES = B.ALTITUDE_MAX_METRES,
        A.P_SPEED_AVG_KMH = B.SPEED_AVG_KMH,
        A.P_SPEED_MED_KMH = B.SPEED_MED_KMH,
        A.P_SPEED_MIN_KMH = B.SPEED_MIN_KMH,
        A.P_SPEED_MAX_KMH = B.SPEED_MAX_KMH,
        A.MD_DATE_MODIFIED = GETDATE(),
        A.MD_JOB_CODE = @P_JOB,
        A.MD_RUN_CODE = @P_RUN,
        A.MD_PACK_NAME = @P_PACK,
        A.MD_MODIFIED_USER = @P_USER,
        A.MD_LOGICAL_DELETE = 0
WHEN NOT MATCHED THEN
    INSERT (
        [PK_ACTIVITY_ID],
        [FK_SK_DIM_USERS],
        [FK_SK_DIM_ORGANISATIONS],
        [FK_SK_DIM_DATE],
        [P_NAME],
        [P_REFERENCE],
        [P_NOTES],
        [P_STATUS],
        [P_TYPE],
        [P_TYPE_CATEGORY],
        [P_START_TIME],
        [P_FINISH_TIME],
        [P_SCHEDULED_START_TIME],
        [P_SCHEDULED_FINISH_TIME],
        [P_IS_PLANNED],
        [P_IS_FAVOURITE],
        [P_IS_ROUND_TRIP],
        [P_IS_ALERTED],
        [P_IS_ONGOING],
        [P_IS_ARCHIVED],
        [P_START_LATITUDE],
        [P_START_LONGITUDE],
        [P_START_ADDRESS],
        [P_DESTINATION_LATITUDE],
        [P_DESTINATION_LONGITUDE],
        [P_DESTINATION_ADDRESS],
        [P_TIMER_TYPE],
        [P_TIMER_TOD_TIME],
        [P_REMINDER_THRESHOLD],
        [P_TIMER_INTERVAL_MINUTES],
        [P_DASHBOARD_URL],
        [P_TRACKER_URL],
        [P_CREATED_AT],
        [P_UPDATED_AT],
        [P_GOT_IN_TROUBLE_AT],
        [P_IS_FOLLOWED_UP],
        [P_IS_FOLLOWED_UP_COMPLETED],
        [P_APPROVAL_STATUS],
        [P_V_BTTN_SERIAL_NUMBER],
        [P_DURATION_SECONDS],
        [P_TOTAL_DISTANCE_METRES],
        [P_AUTO_CHECKIN_COUNT],
        [P_MANUAL_CHECKIN_COUNT],
        [P_HASHTAG_CHECKIN_COUNT],
        [P_GPS_CHECKIN_COUNT],
        [P_VEHICLE_CHECKIN_COUNT],
        [P_ESTIMATED_DISTANCE_METRES],
        [P_ACCURACY_AVG_METRES],
        [P_ALTITUDE_AVG_METRES],
        [P_ALTITUDE_MED_METRES],
        [P_ALTITUDE_MIN_METRES],
        [P_ALTITUDE_MAX_METRES],
        [P_SPEED_AVG_KMH],
        [P_SPEED_MED_KMH],
        [P_SPEED_MIN_KMH],
        [P_SPEED_MAX_KMH],
        [MD_DATE_CREATED],
        [MD_DATE_MODIFIED],
        [MD_JOB_CODE],
        [MD_RUN_CODE],
        [MD_PACK_NAME],
        [MD_MODIFIED_USER],
        [MD_LOGICAL_DELETE]
    )
    VALUES (
        B.ID,
        B.FK_SK_DIM_USERS,
        B.FK_SK_DIM_ORGANISATIONS,
        B.FK_SK_DIM_DATE,
        B.NAME,
        B.REFERENCE,
        B.NOTES,
        B.STATUS,
        B.TYPE,
        B.TYPE_CATEGORY,
        B.START_TIME,
        B.FINISH_TIME,
        B.SCHEDULED_START_TIME,
        B.SCHEDULED_FINISH_TIME,
        B.IS_PLANNED,
        B.IS_FAVOURITE,
        B.IS_ROUND_TRIP,
        B.IS_ALERTED,
        B.IS_ONGOING,
        B.IS_ARCHIVED,
        B.START_LATITUDE,
        B.START_LONGITUDE,
        B.START_ADDRESS,
        B.DESTINATION_LATITUDE,
        B.DESTINATION_LONGITUDE,
        B.DESTINATION_ADDRESS,
        B.TIMER_TYPE,
        B.TIMER_TOD_TIME,
        B.REMINDER_THRESHOLD,
        B.TIMER_INTERVAL_MINUTES,
        B.DASHBOARD_URL,
        B.TRACKER_URL,
        B.CREATED_AT,
        B.UPDATED_AT,
        B.GOT_IN_TROUBLE_AT,
        B.IS_FOLLOWED_UP,
        B.IS_FOLLOWED_UP_COMPLETED,
        B.APPROVAL_STATUS,
        B.V_BTTN_SERIAL_NUMBER,
        B.DURATION_SECONDS,
        B.TOTAL_DISTANCE_METRES,
        B.AUTO_CHECKIN_COUNT,
        B.MANUAL_CHECKIN_COUNT,
        B.HASHTAG_CHECKIN_COUNT,
        B.GPS_CHECKIN_COUNT,
        B.VEHICLE_CHECKIN_COUNT,
        B.ESTIMATED_DISTANCE_METRES,
        B.ACCURACY_AVG_METRES,
        B.ALTITUDE_AVG_METRES,
        B.ALTITUDE_MED_METRES,
        B.ALTITUDE_MIN_METRES,
        B.ALTITUDE_MAX_METRES,
        B.SPEED_AVG_KMH,
        B.SPEED_MED_KMH,
        B.SPEED_MIN_KMH,
        B.SPEED_MAX_KMH,
        GETDATE(),
        GETDATE(),
        @P_JOB,
        @P_RUN,
        @P_PACK,
        @P_USER,
        0
    );

-- Drop the temporary table
DROP TABLE #TEMPEMP;